
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>SConscript.py - Build source files from template &#8212; Microcontrollers: From Assembly Language to C Using the PIC24 family, second edition 6-May-2015 documentation</title>
    <link rel="stylesheet" href="../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../_static/CodeChat.css" type="text/css" />
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '6-May-2015',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true,
        SOURCELINK_SUFFIX: ''
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="SConstruct - Define the SCons build process" href="../SConstruct.html" />
    <link rel="prev" title="SCons_zipit.py - Build docs then create a .zip for distribution" href="../SCons_zipit.py.html" />
   
  <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <script type="text/javascript">document.addEventListener("DOMContentLoaded", function(event) {let walk_tree = function(elements,func_walk,func_child) {let walk_children = [];for (let index = 0; index < elements.length; ++index) {let that = elements[index];while (that && !func_walk(that)) {that = that.parentElement;}if (that) {that = func_walk(that);walk_children.push(that);while (that && func_child(that)) {that = func_child(that);walk_children.push(that);}}}return walk_children;};let code = document.getElementsByClassName("fenced-code");walk_tree(code, x => x.nextElementSibling, x => x.firstElementChild).map(x => {x.style.marginTop = 0;x.style.paddingTop = 0;});walk_tree(code, x => x.previousElementSibling, x => x.lastElementChild).map(x => {x.style.marginBottom = 0;x.style.paddingBottom = 0;});});</script><div class="section" id="sconscript-py-build-source-files-from-template">
<h1>SConscript.py - Build source files from template<a class="headerlink" href="#sconscript-py-build-source-files-from-template" title="Permalink to this headline">¶</a></h1>
<p>Note the .py extension on this file, necessary so that
Doxygen parses as a Python script (but not necessary
for SCons).</p>
<p>This file builds various files from templates in the
templates/ directory in which this file resides. It should
be called from the main SConscript.py script.</p>
<div class="section" id="setup-for-template-building">
<h2>Setup for template building<a class="headerlink" href="#setup-for-template-building" title="Permalink to this headline">¶</a></h2>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span> 
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">string</span> <span class="kn">import</span> <span class="n">Template</span>
<span class="kn">import</span> <span class="nn">csv</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="kn">from</span> <span class="nn">compact_csv</span> <span class="kn">import</span> <span class="n">enumeratePic24Ports</span>
 
</pre></div>
</div>
<p>Import environment from calling SConstruct context</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span><span class="n">Import</span><span class="p">(</span><span class="s1">&#39;env&#39;</span><span class="p">)</span>
 
 
</pre></div>
</div>
</div>
<div class="section" id="functions-supporting-template-file-builds">
<h2>Functions supporting template file builds<a class="headerlink" href="#functions-supporting-template-file-builds" title="Permalink to this headline">¶</a></h2>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span> 
</pre></div>
</div>
<dl class="docutils">
<dt>A function to do search and replaces on a file, optionally</dt>
<dd>appending the results to the output file.</dd>
</dl>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">searchAndReplace</span><span class="p">(</span>
</pre></div>
</div>
<p>Name of the source file</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="n">sourceFile</span><span class="p">,</span>
</pre></div>
</div>
<p>Name of the destination file</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="n">destFileName</span><span class="p">,</span>
</pre></div>
</div>
<p>A dictionary of key=value pairs used by
template to perform the search and replace operation.</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="n">mapping</span><span class="p">,</span>
</pre></div>
</div>
<blockquote>
<div>Mode with which to open the destination file.
Use the default of ‘w’ to overwrite the
destination file with the replaced source file. Use ‘a’ to
append the replaced source file to the destination file.</div></blockquote>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span> <span class="n">openMode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">):</span>
 
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:1.0em;"><p>Use newline=’’ to preserve current line endings; in particular, this
keeps line endings Unix-style, even when run under Windows.</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">destFileName</span><span class="p">,</span> <span class="n">openMode</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outFile</span><span class="p">:</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">sourceFile</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
    <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">mapping</span><span class="p">))</span>
 
</pre></div>
</div>
<dl class="docutils">
<dt>A function to create a .c/.h file from multiple replaces through</dt>
<dd>a template.</dd>
</dl>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">genFromTemplate</span><span class="p">(</span>
</pre></div>
</div>
<p>Name of the template file to use</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="n">templateFileName</span><span class="p">,</span>
</pre></div>
</div>
<p>Name of the destination file to create
by accumulating multiple passes through the template
file</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="n">destFileName</span><span class="p">,</span>
</pre></div>
</div>
<p>Number of iterations (passes) through the file
to make. During each iteration, $x is replaced by the
iteration number.</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="n">iters</span><span class="p">):</span>

  <span class="n">openMode</span> <span class="o">=</span> <span class="s1">&#39;w&#39;</span>
  <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">iters</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">searchAndReplace</span><span class="p">(</span><span class="n">templateFileName</span><span class="p">,</span> <span class="n">destFileName</span><span class="p">,</span>
      <span class="p">{</span><span class="s1">&#39;x&#39;</span> <span class="p">:</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)},</span> <span class="n">openMode</span><span class="p">)</span>
    <span class="n">openMode</span> <span class="o">=</span> <span class="s1">&#39;a&#39;</span>
 
</pre></div>
</div>
<p>Builds a .c from a template – SCons Builder function formation.
Function will build the .c as requested.  Has the proper
inputs, outputs and returns value to be registered SCons environment
as a builder function</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">c_template_builder</span><span class="p">(</span>
</pre></div>
</div>
<p>Target file for this function to build</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="n">target</span><span class="p">,</span>
</pre></div>
</div>
<p>File on which target is built from</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="n">source</span><span class="p">,</span>
</pre></div>
</div>
<p>Environment (if needed)</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="n">env</span><span class="p">):</span>

  <span class="n">s</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">t</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">f</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">g</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">==</span> <span class="s2">&quot;pic24_uart&quot;</span><span class="p">):</span>
    <span class="n">genFromTemplate</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">==</span> <span class="s2">&quot;pic24_i2c&quot;</span><span class="p">):</span>
    <span class="n">genFromTemplate</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">==</span> <span class="s2">&quot;pic24_ecan&quot;</span><span class="p">):</span>
    <span class="n">genFromTemplate</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">==</span> <span class="s2">&quot;pic24_spi&quot;</span><span class="p">):</span>
    <span class="n">genFromTemplate</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
 
</pre></div>
</div>
<p>This routine builds a pic24_ports_config.h file from its template. To do so:</p>
<ol class="arabic simple">
<li>Open the output and template files.</li>
<li>Write the header.</li>
<li>For each port/pin, write a replaced template.</li>
</ol>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">genConfigFromTemplate</span><span class="p">(</span><span class="n">templateFileName</span><span class="p">,</span> <span class="n">destFileName</span><span class="p">):</span>
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:1.0em;"><p>Read in the template.</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">templateFileName</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">templateFile</span><span class="p">:</span>
    <span class="n">template</span> <span class="o">=</span> <span class="n">Template</span><span class="p">(</span><span class="n">templateFile</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:1.0em;"><p>Open the output file.</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">destFileName</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outFile</span><span class="p">:</span>
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:2.0em;"><p>Write the header</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>    <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">c_license_header</span><span class="p">)</span>
    <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;/// </span><span class="se">\\</span><span class="s1">brief Define GPIO configuration macros for all pins of a device.</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span>
                  <span class="s1">&#39;/// See pic24_ports.h for more details.</span><span class="se">\n\n\n</span><span class="s1">&#39;</span><span class="p">);</span>
 
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:2.0em;"><p>Iterate over every port</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>    <span class="n">portlist</span> <span class="o">=</span> <span class="n">enumeratePic24Ports</span><span class="p">()</span>
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:2.0em;"><p>Add in some extra ports for unit testing</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>    <span class="n">portlist</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="s1">&#39;T1&#39;</span><span class="p">,</span> <span class="s1">&#39;T2&#39;</span><span class="p">,</span> <span class="s1">&#39;T3&#39;</span><span class="p">])</span>
    <span class="k">for</span> <span class="n">Rxy</span> <span class="ow">in</span> <span class="n">portlist</span><span class="p">:</span>
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:3.0em;"><p>Evaluate the template for this port/pin.</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>      <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">template</span><span class="o">.</span><span class="n">substitute</span><span class="p">({</span><span class="s1">&#39;x&#39;</span> <span class="p">:</span> <span class="n">Rxy</span><span class="p">}))</span>
 
</pre></div>
</div>
<p>This helper routine splits a string containing a space-separated list of processors into a list. The last element of the list gives the port, which is returned separately.</p>
<p>An asterisk (*) after a processor name is removed; this makes it easier to mark which csv entries have been hand-checked.</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">splitProcessorNames</span><span class="p">(</span><span class="n">port_dict</span><span class="p">):</span>
  <span class="n">processors</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;\*? &#39;</span><span class="p">,</span> <span class="n">port_dict</span><span class="p">[</span><span class="s1">&#39;Device port / pin&#39;</span><span class="p">])</span>
  <span class="n">port</span> <span class="o">=</span> <span class="n">processors</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
  <span class="k">return</span> <span class="n">processors</span><span class="p">,</span> <span class="n">port</span>
 
 
</pre></div>
</div>
<p>This routine builds pic24_ports_tables.h from a template. To do so:</p>
<ol class="arabic simple">
<li>Open the output file and write out the header.</li>
<li>Load in the CSV file containing pin information:<ol class="arabic">
<li>Load three rows; they should be labeled xxx RPy, xxx ANn, and xxx CNm, where xxx is the processor.</li>
<li>For each Rxy value:<ol class="arabic">
<li>For F/H devices: look at the corresponding RPy, ANn, and CNm. If any are non-empty, write a table entry.</li>
<li>For E devices: Write a #define for RPy or ANn if either are non-empty.</li>
</ol>
</li>
</ol>
</li>
<li>Write out the footer.</li>
</ol>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">genTablesFromTemplate</span><span class="p">(</span><span class="n">csvFileName</span><span class="p">,</span> <span class="n">destFileName</span><span class="p">):</span>
  <span class="n">portlist</span> <span class="o">=</span> <span class="n">enumeratePic24Ports</span><span class="p">()</span>
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:1.0em;"><p>Read in the CSV containing device information.</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">csvFileName</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">csvFile</span><span class="p">:</span>
    <span class="n">csv_dict_reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csvFile</span><span class="p">)</span><span class="o">.</span><span class="fm">__iter__</span><span class="p">()</span>
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:2.0em;"><p>Open the output file.</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">destFileName</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">newline</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">outFile</span><span class="p">:</span>
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:3.0em;"><p>Write the header</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>      <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">c_license_header</span><span class="p">)</span>
      <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;/// </span><span class="se">\\</span><span class="s1">brief Define device-specific mappings from Rxy to RPy, ANn, and CNm pins.</span><span class="se">\n\n</span><span class="s1">#if 0</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:3.0em;"><p>Walk through the file</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>      <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:5.0em;"><p>Read three rows</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>          <span class="k">try</span><span class="p">:</span>
              <span class="n">RPy</span> <span class="o">=</span> <span class="n">csv_dict_reader</span><span class="o">.</span><span class="n">__next__</span><span class="p">()</span>
              <span class="n">ANn</span> <span class="o">=</span> <span class="n">csv_dict_reader</span><span class="o">.</span><span class="n">__next__</span><span class="p">()</span>
              <span class="n">CNm</span> <span class="o">=</span> <span class="n">csv_dict_reader</span><span class="o">.</span><span class="n">__next__</span><span class="p">()</span>
          <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
              <span class="k">break</span>
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:5.0em;"><p>Gather processor information. Make sure all three rows refer to the same processors and to the expected ports.</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>          <span class="n">processors</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">splitProcessorNames</span><span class="p">(</span><span class="n">RPy</span><span class="p">)</span>
          <span class="k">assert</span> <span class="n">port</span> <span class="o">==</span> <span class="s1">&#39;RPy&#39;</span>
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:5.0em;"><p>Check: all processors in this group should be unique.</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>          <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">processors</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">processors</span><span class="p">)):</span>
              <span class="k">print</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processors</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; contains duplicates.&quot;</span><span class="p">)</span>
              <span class="k">assert</span> <span class="bp">False</span>
          <span class="n">processors_temp</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">splitProcessorNames</span><span class="p">(</span><span class="n">ANn</span><span class="p">)</span>
          <span class="k">assert</span> <span class="n">processors</span> <span class="o">==</span> <span class="n">processors_temp</span>
          <span class="k">assert</span> <span class="n">port</span> <span class="o">==</span> <span class="s1">&#39;ANn&#39;</span>
          <span class="n">processors_temp</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">splitProcessorNames</span><span class="p">(</span><span class="n">CNm</span><span class="p">)</span>
          <span class="k">assert</span> <span class="n">processors</span> <span class="o">==</span> <span class="n">processors_temp</span>
          <span class="k">assert</span> <span class="n">port</span> <span class="o">==</span> <span class="s1">&#39;CNm&#39;</span>
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:5.0em;"><p>Write out processor information.</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>          <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">#elif defined(__&#39;</span> <span class="o">+</span> <span class="s1">&#39;__) || </span><span class="se">\\\n</span><span class="s1">      defined(__&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">processors</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;__)</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:5.0em;"><p>Walk through each Rxy on this processor</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>          <span class="k">for</span> <span class="n">Rxy</span> <span class="ow">in</span> <span class="n">portlist</span><span class="p">:</span>
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:7.0em;"><p>Get the specific values for this Rxy.</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>              <span class="n">_RPy</span> <span class="o">=</span> <span class="n">RPy</span><span class="p">[</span><span class="n">Rxy</span><span class="p">]</span>
              <span class="n">_ANn</span> <span class="o">=</span> <span class="n">ANn</span><span class="p">[</span><span class="n">Rxy</span><span class="p">]</span>
              <span class="n">_CNm</span> <span class="o">=</span> <span class="n">CNm</span><span class="p">[</span><span class="n">Rxy</span><span class="p">]</span>
              <span class="k">if</span> <span class="n">_RPy</span><span class="p">:</span>
                  <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# define R</span><span class="si">%s</span><span class="s1">_RP </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Rxy</span><span class="p">,</span> <span class="n">_RPy</span><span class="p">))</span>
              <span class="k">if</span> <span class="n">_ANn</span><span class="p">:</span>
                  <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# define R</span><span class="si">%s</span><span class="s1">_AN </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Rxy</span><span class="p">,</span> <span class="n">_ANn</span><span class="p">))</span>
              <span class="k">if</span> <span class="n">_CNm</span><span class="p">:</span>
                  <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;# define R</span><span class="si">%s</span><span class="s1">_CN </span><span class="si">%s</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">Rxy</span><span class="p">,</span> <span class="n">_CNm</span><span class="p">))</span>
</pre></div>
</div>
<div class="CodeChat-indent" style="margin-left:3.0em;"><p>Write footer</p>
</div><div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>      <span class="n">outFile</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s1">&#39;#else</span><span class="se">\n</span><span class="s1"># error &quot;Port information not defined.&quot;</span><span class="se">\n</span><span class="s1">#endif</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
 
</pre></div>
</div>
<p>Builds a .h from a .csv – SCons Builder function formation.
Has the proper
inputs, outputs and returns value to be registered SCons environment as a builder function.</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">csv_template_builder</span><span class="p">(</span>
</pre></div>
</div>
<blockquote>
<div>Target file for this function to build</div></blockquote>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="n">target</span><span class="p">,</span>
</pre></div>
</div>
<blockquote>
<div>File on which target is built from</div></blockquote>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="n">source</span><span class="p">,</span>
</pre></div>
</div>
<blockquote>
<div>Environment (if needed)</div></blockquote>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="n">env</span><span class="p">):</span>

  <span class="n">s</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">t</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">f</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">g</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="n">genTablesFromTemplate</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
 
</pre></div>
</div>
<p>Builds a .h from a template – SCons Builder function formation.
Function will build the .c as requested.  Has the proper
inputs, outputs and returns value to be registered SCons environment
as a builder function</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">h_template_builder</span><span class="p">(</span>
</pre></div>
</div>
<p>Target file for this function to build</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="n">target</span><span class="p">,</span>
</pre></div>
</div>
<p>File on which target is built from</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="n">source</span><span class="p">,</span>
</pre></div>
</div>
<p>Environment (if needed)</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span>  <span class="n">env</span><span class="p">):</span>

  <span class="n">s</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">t</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
  <span class="n">f</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">target</span><span class="p">[</span><span class="mi">0</span><span class="p">]))[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
  <span class="n">g</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">==</span> <span class="s2">&quot;pic24_uart&quot;</span><span class="p">):</span>
    <span class="n">genFromTemplate</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">4</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">==</span> <span class="s2">&quot;pic24_i2c&quot;</span><span class="p">):</span>
    <span class="n">genFromTemplate</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">==</span> <span class="s2">&quot;pic24_ecan&quot;</span><span class="p">):</span>
    <span class="n">genFromTemplate</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">g</span> <span class="o">==</span> <span class="s2">&quot;pic24_ports_config&quot;</span><span class="p">):</span>
    <span class="n">genConfigFromTemplate</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
 
</pre></div>
</div>
<p>Define and register a template-driven builder for .c files</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span><span class="n">cbldr</span> <span class="o">=</span> <span class="n">Builder</span><span class="p">(</span><span class="n">action</span> <span class="o">=</span> <span class="n">c_template_builder</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.c&#39;</span><span class="p">,</span> <span class="n">src_suffix</span><span class="o">=</span><span class="s1">&#39;.c-template&#39;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">BUILDERS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;CTemplate&#39;</span> <span class="p">:</span> <span class="n">cbldr</span><span class="p">})</span>
 
</pre></div>
</div>
<p>Define and register a template-driven builder for .h files</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span><span class="n">hbldr</span> <span class="o">=</span> <span class="n">Builder</span><span class="p">(</span><span class="n">action</span> <span class="o">=</span> <span class="n">h_template_builder</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.h&#39;</span><span class="p">,</span> <span class="n">src_suffix</span><span class="o">=</span><span class="s1">&#39;.h-template&#39;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">BUILDERS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;HTemplate&#39;</span> <span class="p">:</span> <span class="n">hbldr</span><span class="p">})</span>
 
</pre></div>
</div>
<p>Define and register a CVS-driven builder for .csv files</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span><span class="n">csvbldr</span> <span class="o">=</span> <span class="n">Builder</span><span class="p">(</span><span class="n">action</span> <span class="o">=</span> <span class="n">csv_template_builder</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s1">&#39;.h&#39;</span><span class="p">,</span> <span class="n">src_suffix</span><span class="o">=</span><span class="s1">&#39;.csv&#39;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">Append</span><span class="p">(</span><span class="n">BUILDERS</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;CSVTemplate&#39;</span> <span class="p">:</span> <span class="n">csvbldr</span><span class="p">})</span>
 
 
 
</pre></div>
</div>
</div>
<div class="section" id="calls-to-build-templates">
<h2>Calls to build templates<a class="headerlink" href="#calls-to-build-templates" title="Permalink to this headline">¶</a></h2>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span> 
</pre></div>
</div>
<p>Specify which files are produced by templates</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span><span class="n">env</span><span class="o">.</span><span class="n">HTemplate</span><span class="p">(</span><span class="s1">&#39;../lib/include/pic24_uart&#39;</span><span class="p">,</span><span class="s1">&#39;pic24_uart&#39;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">HTemplate</span><span class="p">(</span><span class="s1">&#39;../lib/include/pic24_i2c&#39;</span><span class="p">,</span><span class="s1">&#39;pic24_i2c&#39;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">HTemplate</span><span class="p">(</span><span class="s1">&#39;../lib/include/pic24_ecan&#39;</span><span class="p">,</span><span class="s1">&#39;pic24_ecan&#39;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">HTemplate</span><span class="p">(</span><span class="s1">&#39;../lib/include/pic24_ports_config&#39;</span><span class="p">,</span><span class="s1">&#39;pic24_ports_config&#39;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">CSVTemplate</span><span class="p">(</span><span class="s1">&#39;../lib/include/pic24_ports_mapping&#39;</span><span class="p">,</span><span class="s1">&#39;pic24_devices&#39;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">CTemplate</span><span class="p">(</span><span class="s1">&#39;../lib/src/pic24_uart&#39;</span><span class="p">,</span><span class="s1">&#39;pic24_uart&#39;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">CTemplate</span><span class="p">(</span><span class="s1">&#39;../lib/src/pic24_i2c&#39;</span><span class="p">,</span><span class="s1">&#39;pic24_i2c&#39;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">CTemplate</span><span class="p">(</span><span class="s1">&#39;../lib/src/pic24_ecan&#39;</span><span class="p">,</span><span class="s1">&#39;pic24_ecan&#39;</span><span class="p">)</span>
<span class="n">env</span><span class="o">.</span><span class="n">CTemplate</span><span class="p">(</span><span class="s1">&#39;../lib/src/pic24_spi&#39;</span><span class="p">,</span><span class="s1">&#39;pic24_spi&#39;</span><span class="p">)</span>

<span class="n">env</span><span class="o">.</span><span class="n">Alias</span><span class="p">(</span><span class="s1">&#39;template-build&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;../lib/include/pic24_uart.h&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;../lib/include/pic24_i2c.h&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;../lib/include/pic24_ecan.h&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;../lib/include/pic24_ports_config.h&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;../lib/include/pic24_ports_mapping.h&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;../lib/src/pic24_uart.c&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;../lib/src/pic24_i2c.c&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;../lib/src/pic24_spi.c&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;../lib/src/pic24_ecan.c&#39;</span><span class="p">]);</span>
 
 
 
 
</pre></div>
</div>
<p>Header, containing the license as a C comment.</p>
<div class="code fenced-code highlight-python"><div class="highlight"><pre><span></span><span class="n">c_license_header</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;/*</span>
<span class="s2"> * &quot;Copyright (c) 2017 Robert B. Reese, Bryan A. Jones, J. W. Bruce (&quot;AUTHORS&quot;)&quot;</span>
<span class="s2"> * All rights reserved.</span>
<span class="s2"> * (R. Reese, reese_AT_ece.msstate.edu, Mississippi State University)</span>
<span class="s2"> * (B. A. Jones, bjones_AT_ece.msstate.edu, Mississippi State University)</span>
<span class="s2"> * (J. W. Bruce, jwbruce_AT_ece.msstate.edu, Mississippi State University)</span>
<span class="s2"> *</span>
<span class="s2"> * Permission to use, copy, modify, and distribute this software and its</span>
<span class="s2"> * documentation for any purpose, without fee, and without written agreement is</span>
<span class="s2"> * hereby granted, provided that the above copyright notice, the following</span>
<span class="s2"> * two paragraphs and the authors appear in all copies of this software.</span>
<span class="s2"> *</span>
<span class="s2"> * IN NO EVENT SHALL THE &quot;AUTHORS&quot; BE LIABLE TO ANY PARTY FOR</span>
<span class="s2"> * DIRECT, INDIRECT, SPECIAL, INCIDENTAL, OR CONSEQUENTIAL DAMAGES ARISING OUT</span>
<span class="s2"> * OF THE USE OF THIS SOFTWARE AND ITS DOCUMENTATION, EVEN IF THE &quot;AUTHORS&quot;</span>
<span class="s2"> * HAS BEEN ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.</span>
<span class="s2"> *</span>
<span class="s2"> * THE &quot;AUTHORS&quot; SPECIFICALLY DISCLAIMS ANY WARRANTIES,</span>
<span class="s2"> * INCLUDING, BUT NOT LIMITED TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY</span>
<span class="s2"> * AND FITNESS FOR A PARTICULAR PURPOSE.  THE SOFTWARE PROVIDED HEREUNDER IS</span>
<span class="s2"> * ON AN &quot;AS IS&quot; BASIS, AND THE &quot;AUTHORS&quot; HAS NO OBLIGATION TO</span>
<span class="s2"> * PROVIDE MAINTENANCE, SUPPORT, UPDATES, ENHANCEMENTS, OR MODIFICATIONS.&quot;</span>
<span class="s2"> *</span>
<span class="s2"> * Please maintain this header in its entirety when copying/modifying</span>
<span class="s2"> * these files.</span>
<span class="s2"> *</span>
<span class="s2"> *</span>
<span class="s2"> */</span>

<span class="s2">/// </span><span class="se">\\</span><span class="s2">file</span>
<span class="s2">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../contents.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">SConscript.py - Build source files from template</a><ul>
<li><a class="reference internal" href="#setup-for-template-building">Setup for template building</a></li>
<li><a class="reference internal" href="#functions-supporting-template-file-builds">Functions supporting template file builds</a></li>
<li><a class="reference internal" href="#calls-to-build-templates">Calls to build templates</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../contents.html">Documentation overview</a><ul>
  <li><a href="../utilities.html">Utilities</a><ul>
  <li><a href="../SConstruct.py.html">SConstruct.py - Build all libraries and examples over many chips</a><ul>
      <li>Previous: <a href="../SCons_zipit.py.html" title="previous chapter">SCons_zipit.py - Build docs then create a .zip for distribution</a></li>
      <li>Next: <a href="../SConstruct.html" title="next chapter">SConstruct - Define the SCons build process</a></li>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/templates/SConscript.py"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2017, Bryan A. Jones, Robert B. Reese, and J. W. Bruce.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.6.5</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.10</a>
      
      |
      <a href="../_sources/templates/SConscript.py"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>